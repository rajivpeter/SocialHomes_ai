import { useState } from 'react';
import { ShieldAlert, ChevronDown, ChevronUp, AlertTriangle, CheckCircle, Flag } from 'lucide-react';
import { useVulnerability } from '@/hooks/useApi';

const LEVEL_COLOURS: Record<string, string> = {
  low: 'text-status-compliant',
  moderate: 'text-status-warning',
  high: 'text-status-critical',
  critical: 'text-status-critical',
};

const LEVEL_BG: Record<string, string> = {
  low: 'bg-status-compliant/20 border-status-compliant/30',
  moderate: 'bg-status-warning/20 border-status-warning/30',
  high: 'bg-status-critical/20 border-status-critical/30',
  critical: 'bg-status-critical/30 border-status-critical/50',
};

export default function VulnerabilityPanel({ tenantId }: { tenantId: string }) {
  const { data: assessment, isLoading, error } = useVulnerability(tenantId);
  const [expanded, setExpanded] = useState(false);

  if (isLoading) {
    return (
      <div className="bg-surface-card rounded-lg border border-border-default p-6 animate-pulse">
        <div className="h-6 bg-surface-elevated rounded w-56 mb-4" />
        <div className="h-16 bg-surface-elevated rounded" />
      </div>
    );
  }

  if (error || !assessment) return null;

  const level = assessment.level ?? 'low';

  return (
    <div className="bg-surface-card rounded-lg border border-border-default p-6">
      <div className="flex items-center gap-2 mb-4">
        <ShieldAlert size={20} className="text-status-ai" />
        <h3 className="text-lg font-bold text-brand-peach">Vulnerability Assessment</h3>
        <span className="text-[10px] px-2 py-0.5 bg-status-ai/20 text-status-ai rounded-full font-medium">AI</span>
      </div>

      {/* Score */}
      <div className="flex items-center gap-6 mb-4">
        <div className={`p-4 rounded-lg border-2 ${LEVEL_BG[level]}`}>
          <div className={`text-3xl font-bold ${LEVEL_COLOURS[level]}`}>{assessment.overallScore}</div>
          <div className="text-xs text-text-muted mt-1">/ 100</div>
        </div>
        <div className="flex-1">
          <div className={`text-sm font-semibold uppercase tracking-wider ${LEVEL_COLOURS[level]} mb-1`}>
            {level} vulnerability
          </div>
          <p className="text-xs text-text-muted">7-factor analysis: deprivation, arrears, health, isolation, age, dependents, UC transition</p>
        </div>
      </div>

      {/* Factor Bars */}
      <div className="space-y-2 mb-4">
        {(assessment.factors ?? []).map((factor: any) => (
          <div key={factor.name} className="flex items-center gap-3">
            <div className="text-xs text-text-secondary w-32 shrink-0">{factor.name}</div>
            <div className="flex-1 bg-surface-elevated rounded-full h-2">
              <div
                className={`h-2 rounded-full transition-all duration-700 ${
                  factor.rawScore > 70 ? 'bg-status-critical' : factor.rawScore > 40 ? 'bg-status-warning' : 'bg-status-compliant'
                }`}
                style={{ width: `${factor.rawScore}%` }}
              />
            </div>
            <span className="text-xs text-text-muted w-8 text-right">{factor.rawScore}</span>
          </div>
        ))}
      </div>

      {/* New Flags Detected */}
      {(assessment.newFlagsDetected ?? []).length > 0 && (
        <div className="bg-status-warning/10 border border-status-warning/20 rounded-lg p-3 mb-3">
          <div className="flex items-center gap-2 text-sm font-medium text-status-warning mb-1">
            <Flag size={14} />
            New flags detected
          </div>
          <div className="flex flex-wrap gap-1">
            {assessment.newFlagsDetected.map((flag: string, i: number) => (
              <span key={i} className="text-xs px-2 py-0.5 bg-status-warning/20 rounded text-status-warning">{flag}</span>
            ))}
          </div>
        </div>
      )}

      {/* Actions */}
      <div className="border-t border-border-default pt-3">
        <button
          onClick={() => setExpanded(!expanded)}
          className="flex items-center gap-2 text-sm font-medium text-status-ai hover:text-status-ai/80 transition-colors"
        >
          {expanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
          {(assessment.recommendedActions ?? []).length} Recommended Action{(assessment.recommendedActions ?? []).length !== 1 ? 's' : ''}
        </button>
        {expanded && (
          <ul className="mt-2 space-y-1">
            {(assessment.recommendedActions ?? []).map((action: string, i: number) => (
              <li key={i} className="text-xs text-text-muted flex items-start gap-2">
                <span className="text-status-ai mt-0.5">-</span>
                {action}
              </li>
            ))}
          </ul>
        )}
      </div>
    </div>
  );
}
